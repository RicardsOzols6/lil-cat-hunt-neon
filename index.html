<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lil Cat Hunt ‚Äì Minimal</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; }
    input { padding: 8px 10px; border-radius: 8px; border: 1px solid #ddd; }
    .ok { color:#065f46; background:#dcfce7; padding:8px 10px; border-radius:8px; }
    .err { color:#7f1d1d; background:#fee2e2; padding:8px 10px; border-radius:8px; white-space:pre-wrap;}
    .box { border:1px solid #eee; border-radius:10px; padding:12px; margin:12px 0;}
    ul { padding-left: 18px; }
  </style>
</head>
<body>
  <h1>üêæ Lil Cat Hunt (Minimal)</h1>
  <div id="status">Booting‚Ä¶</div>

  <div id="app" class="box" style="display:none">
    <div><b id="title">Game</b> ‚Äî <span id="score">0 / 0</span></div>
    <div class="row">
      <button id="found">üêæ Found one</button>
      <button id="undo">‚Ü©Ô∏è Undo</button>
      <button id="add">‚ûï Add cat</button>
      <button id="remove">‚ûñ Remove cat</button>
    </div>
    <div class="row">
      <input id="many" type="number" min="1" value="1" style="width:90px" />
      <button id="addmany">‚ú® Add many</button>
    </div>
    <h3>Activity</h3>
    <ul id="log"></ul>
    <h3>Hidden cats</h3>
    <ul id="cats"></ul>
  </div>

<script>
(function(){
  const FN_URL = "/.netlify/functions/game";     // direct function call

  const $ = (id)=>document.getElementById(id);
  const status = $("status"), app = $("app"), score = $("score"), title = $("title");
  const log = $("log"), cats = $("cats");

  const ui = {
    showOk: (m)=> status.innerHTML = `<div class="ok">${m}</div>`,
    showErr: (m)=> status.innerHTML = `<div class="err">${m}</div>`,
    render(s){
      app.style.display = "block";
      title.textContent = s.game_name || "Lil Cat Hunt";
      score.textContent = `${s.found} / ${s.total}`;
      log.innerHTML = (s.history||[]).map(h=>`<li>${h.type} ${h.delta??""} ‚Äî <small>${new Date(h.when).toLocaleString()}</small></li>`).join("") || "<li><i>none</i></li>";
      cats.innerHTML = (s.hidden_cats||[]).map((c,i)=>`<li>${i < s.found ? "‚úÖ" : "‚ùì"} ${c.name||("Cat #"+(i+1))}</li>`).join("") || "<li><i>none</i></li>";
    }
  };

  async function api(path, opts){
    const r = await fetch(path, opts);
    const txt = await r.text();
    try { return { ok:r.ok, json: JSON.parse(txt), raw: txt }; }
    catch { return { ok:r.ok, json:null, raw:txt }; }
  }

  let state = { found:0, total:0, game_name:"üêæ Lil Cat Hunt üêæ", hidden_cats:[], history:[] };

  function saveAndRender(){
    api(FN_URL, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ state }) })
      .then(res=>{
        if(!res.ok){ ui.showErr("POST failed:\n"+res.raw); return; }
        state = res.json; ui.render(state);
      })
      .catch(e=> ui.showErr("POST error:\n"+(e?.message||e)));
  }

  // wire buttons
  document.addEventListener("click",(e)=>{
    const id = e.target.id;
    if(id==="found"){ if(state.found < state.total){ state.found++; state.history=[{type:"found+",delta:1,when:new Date().toISOString()}, ...state.history]; saveAndRender(); } }
    if(id==="undo"){ if(state.found>0){ state.found--; state.history=[{type:"found-",delta:-1,when:new Date().toISOString()}, ...state.history]; saveAndRender(); } }
    if(id==="add"){ state.total++; state.hidden_cats=[...(state.hidden_cats||[]), {id:Date.now(), name:`Cat #${state.hidden_cats.length+1}`}]; state.history=[{type:"total+",delta:1,when:new Date().toISOString()}, ...state.history]; saveAndRender(); }
    if(id==="remove"){ if(state.total>state.found){ state.total--; state.hidden_cats=(state.hidden_cats||[]).slice(0,-1); state.history=[{type:"total-",delta:-1,when:new Date().toISOString()}, ...state.history]; saveAndRender(); } }
    if(id==="addmany"){ const n = parseInt($("many").value,10); if(n>0){ for(let i=0;i<n;i++){ state.hidden_cats.push({id:Date.now()+i,name:`Cat #${state.hidden_cats.length+1}`}); } state.total += n; state.history=[{type:"total+",delta:n,when:new Date().toISOString()}, ...state.history]; saveAndRender(); } }
  });

  // bootstrap
  (async function(){
    ui.showOk("Connecting to backend‚Ä¶");
    try {
      const res = await api(FN_URL);
      if(!res.ok){ ui.showErr("GET failed:\n"+res.raw); return; }
      state = res.json; ui.showOk("Connected ‚úì"); ui.render(state);
    } catch(e){
      ui.showErr("GET error:\n"+(e?.message||e));
    }
  })();
})();
</script>
</body>
</html>
