<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lil Cat Hunt üêæ</title>
  <style>
    :root{
      --card:#ffffff; --txt:#0f172a; --muted:#64748b; --accent:#ec4899;
      --ok:#dcfce7; --okb:#bbf7d0; --oktxt:#065f46; --err:#fee2e2; --errb:#fecaca; --errtxt:#7f1d1d;
      --chip:#fde68a;
    }
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--txt);
      background: radial-gradient(1200px 1200px at 10% 10%, #ffe9f2, transparent 60%),
                  radial-gradient(1200px 1200px at 90% 20%, #f3e8ff, transparent 60%),
                  radial-gradient(1200px 1200px at 50% 100%, #e0f2fe, transparent 60%);
      animation: floatBG 20s linear infinite;
      background-size: 200% 200%;
    }
    @keyframes floatBG {
      0% { background-position: 0% 0%, 100% 0%, 50% 100%; }
      50%{ background-position: 100% 50%, 0% 50%, 50% 0%; }
      100%{ background-position: 0% 0%, 100% 0%, 50% 100%; }
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    h1{margin:0 0 12px 0;letter-spacing:0.2px}
    .card{background:var(--card);border:2px solid #fecdd3;border-radius:18px;box-shadow:0 4px 16px rgba(0,0,0,0.06);padding:16px;margin-bottom:16px;backdrop-filter:saturate(120%) blur(2px)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .title{font-size:20px;font-weight:800;margin:0 0 6px 0;display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;background:#f1f5f9}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:white;border:2px solid #e2e8f0}
    .btn.danger{background:#ef4444;color:white}
    select,input[type=text]{border:2px solid #e2e8f0;border-radius:12px;padding:10px 12px;outline:none;font:inherit;background:#fff}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#f1f5f9}
    .chip{background:var(--chip);padding:2px 8px;border-radius:999px;font-size:12px}
    .progress{height:10px;border-radius:999px;background:#ffe4e6;overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#e879f9,#fb7185);width:0%}
    .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .li{background:#ffffffb3;border:1px solid #e9d5ff;border-radius:10px;padding:8px 10px;font-size:14px;display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .catrow{background:#ffffffb3;border:1px solid #bbf7d0;border-radius:10px;padding:8px 10px;font-size:14px;display:flex;gap:8px;align-items:center}
    .ok{background:var(--ok);border:2px solid var(--okb);color:var(--oktxt);padding:10px 12px;border-radius:12px;margin-bottom:12px}
    .err{background:var(--err);border:2px solid var(--errb);color:var(--errtxt);padding:10px 12px;border-radius:12px;margin-bottom:12px;white-space:pre-wrap}
    .section{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.section{grid-template-columns:1fr}}
    .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.2);z-index:20;opacity:0;transition:.2s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .emoji{position:fixed;pointer-events:none;font-size:22px;animation:pop 900ms ease-out forwards}
    @keyframes pop {
      0%{ transform:translate(var(--x,0),var(--y,0)) scale(.6) rotate(0deg); opacity:1 }
      100%{ transform:translate(var(--xend,0),var(--yend,-160px)) scale(1.2) rotate(30deg); opacity:0 }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>üêæ Lil Cat Hunt</h1>
  <div id="status"></div>

  <div class="card">
    <div class="title"><span id="gameName">Lil Cat Hunt</span> <span class="pill" id="score">0 / 0</span></div>
    <div class="muted">Shared scoreboard. Names stay ü´• hidden until you find them.</div>
    <div class="progress" style="margin-top:8px"><div class="bar" id="bar" style="width:0%"></div></div>
  </div>

  <div class="section">
    <div class="card">
      <div class="title">Found a Cat</div>
      <div class="row">
        <select id="fColor"><option>Black</option><option>Orange</option><option>Beige</option></select>
        <select id="fLoc">
          <option>Kitchen</option><option>Emyl‚Äôs Bathroom</option><option>Richards Bathroom</option>
          <option>Emyl‚Äôs Room</option><option>Richards Room</option><option>Storage Room 1</option>
          <option>Storage Room 2</option><option>Hallway</option>
        </select>
        <button class="btn primary" id="foundBtn">Count it üêæ</button>
      </div>
      <div class="muted" id="foundResult" style="margin-top:6px"></div>
    </div>

    <div class="card" id="adminAdd" style="display:none">
      <div class="title">Add Cat <span class="chip">Admin</span></div>
      <div class="row">
        <select id="aColor"><option>Black</option><option>Orange</option><option>Beige</option></select>
        <select id="aLoc">
          <option>Kitchen</option><option>Emyl‚Äôs Bathroom</option><option>Richards Bathroom</option>
          <option>Emyl‚Äôs Room</option><option>Richards Room</option><option>Storage Room 1</option>
          <option>Storage Room 2</option><option>Hallway</option>
        </select>
        <input id="aName" type="text" placeholder="Name (Emyl sees this)" />
        <button class="btn ghost" id="addBtn">Add</button>
      </div>
      <div class="muted">Total goes up when you add cats.</div>
    </div>
  </div>

  <div class="card">
    <div class="title">Activity <span id="moreToggle" class="pill" style="cursor:pointer; margin-left:auto">Show more</span></div>
    <ul class="list" id="activity"></ul>
    <div id="adminActions" class="row" style="display:none; margin-top:6px">
      <button class="btn danger" id="clearHistory">Clear activity</button>
    </div>
  </div>

  <div class="card">
    <div class="title">Cat List</div>
    <ul class="list" id="cats"></ul>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  const FN = "/.netlify/functions/game";
  const $ = (id)=>document.getElementById(id);
  const status = $("status"), toast = $("toast");
  const gameNameEl = $("gameName"), score = $("score"), bar = $("bar");
  const foundResult = $("foundResult"), activity = $("activity"), cats = $("cats");
  const adminAdd = $("adminAdd"), adminActions = $("adminActions"), moreToggle = $("moreToggle");

  const params = new URLSearchParams(location.search);
  const adminCode = params.get("admin");
  const adminQS = adminCode ? `?admin=${encodeURIComponent(adminCode)}` : "";
  const isAdmin = !!adminCode;

  const ding = (f=880, ms=120)=>{ try{
    const a = new (window.AudioContext||window.webkitAudioContext)();
    const o = a.createOscillator(), g = a.createGain(); o.connect(g); g.connect(a.destination);
    o.type="sine"; o.frequency.value=f; g.gain.setValueAtTime(0.0001, a.currentTime);
    g.gain.exponentialRampToValueAtTime(0.3, a.currentTime+0.02);
    o.start(); o.stop(a.currentTime + ms/1000);
  }catch{} };

  const emojis = ["üê±","üêæ","‚ú®","üéâ","üò∫","üíñ","üåü"];
  function burst(x=window.innerWidth/2,y=80){
    for(let i=0;i<16;i++){
      const s=document.createElement("div");
      s.className="emoji"; s.textContent=emojis[i%emojis.length];
      const dx=(Math.random()*2-1)*180, dy=- (80+Math.random()*140);
      s.style.left=`${x}px`; s.style.top=`${y}px`;
      s.style.setProperty('--x','0px'); s.style.setProperty('--y','0px');
      s.style.setProperty('--xend', dx+'px'); s.style.setProperty('--yend', dy+'px');
      document.body.appendChild(s);
      setTimeout(()=>s.remove(), 1000);
    }
  }
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1800);
  }

  function uiStatus(ok, msg){ status.innerHTML = `<div class="${ok?'ok':'err'}">${msg}</div>`; }
  function escapeHTML(s){return String(s??"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

  const state = { found:0, total:0, game_name:"üêæ Lil Cat Hunt üêæ", hidden_cats:[], history:[] };

  let expanded = false;  // activity collapse
  let lastTotal = 0;     // for popup polling

  function render(){
    gameNameEl.textContent = state.game_name || "Lil Cat Hunt";
    score.textContent = `${state.found} / ${state.total}`;
    bar.style.width = state.total>0 ? Math.round(100*state.found/state.total)+'%' : '0%';

    const logs = state.history || [];
    const show = expanded ? logs : logs.slice(0,4);
    activity.innerHTML = show.map(h=>{
      const icon = h.type==='found+'?'‚úÖ':'‚ûï';
      const name = h.name || 'ü´• Hidden';
      const when = new Date(h.when).toLocaleString();
      return `<li class="li"><div>${icon} <b>${escapeHTML(name)}</b> <span class="muted">(${escapeHTML(h.color||'')}, ${escapeHTML(h.where||'')})</span></div><div class="muted">${when}</div></li>`;
    }).join("") || `<li class="li"><div class="muted">No adventures yet.</div></li>`;

    moreToggle.textContent = expanded ? "Show less" : "Show more";
    adminAdd.style.display = isAdmin ? "block" : "none";
    adminActions.style.display = isAdmin ? "flex" : "none";

    cats.innerHTML = (state.hidden_cats||[]).map(c=>{
      const left = `${c.found?'‚úÖ':'‚ùì'} <b>${escapeHTML(c.name||'ü´• Hidden')}</b> <span class="muted">¬∑ ${escapeHTML(c.color||'')} ¬∑ ${escapeHTML(c.location||'')}</span>`;
      const del = isAdmin ? `<button class="btn danger" data-del="${c.id}">Delete</button>` : "";
      return `<li class="catrow">${left} <span style="margin-left:auto"></span>${del}</li>`;
    }).join("") || `<li class="li"><div class="muted">No cats yet.</div></li>`;

    if (isAdmin){
      cats.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          try{ await post({ action:"deleteCat", id: Number(btn.dataset.del) }); ding(340,120); }
          catch(e){ uiStatus(false, e.message||e); }
        }
      });
    }
  }

  moreToggle.onclick = ()=>{ expanded = !expanded; render(); };

  async function get(){
    const r = await fetch(FN + adminQS);
    if(!r.ok){ throw new Error(await r.text()); }
    return r.json();
  }
  async function post(body){
    const url = FN + adminQS;
    const r = await fetch(url,{method:"POST",headers:{'content-type':'application/json'},body:JSON.stringify(body)});
    const txt = await r.text();
    let json; try{ json = JSON.parse(txt) }catch{ json = null }
    if(!r.ok){ throw new Error(json?.error || txt || r.status); }
    Object.assign(state, json);
    render();
    return json;
  }

  $("foundBtn").addEventListener("click", async ()=>{
    try{
      const color = $("fColor").value, location = $("fLoc").value;
      await post({ action:"found", color, location });
      foundResult.textContent = "Nice! One revealed üéâ";
      ding(880,120); setTimeout(()=>ding(1320,120),120); burst();
    }catch(e){
      uiStatus(false, (e?.message||e));
      foundResult.textContent = "";
    }
  });

  $("addBtn").addEventListener("click", async ()=>{
    try{
      const color = $("aColor").value, location = $("aLoc").value, name = $("aName").value.trim();
      await post({ action:"addHidden", color, location, name });
      $("aName").value = "";
      ding(700,120); burst();
    }catch(e){ uiStatus(false, "Add failed: "+(e?.message||e)); }
  });

  $("clearHistory").addEventListener("click", async ()=>{
    if(!confirm("Clear the whole activity log?")) return;
    try{ await post({ action:"clearHistory" }); ding(300,120); }
    catch(e){ uiStatus(false, "Clear failed: "+(e?.message||e)); }
  });

  // Poll every 15s: if total increases (and you‚Äôre NOT admin), show popup
  setInterval(async ()=>{
    try{
      if (isAdmin) return;
      const data = await get();
      if (typeof lastTotal === "number" && data.total > lastTotal) {
        showToast("‚ú® Emyl added a new cat!");
        burst();
      }
      lastTotal = data.total;
      Object.assign(state, data); render();
    }catch{}
  }, 15000);

  // boot
  (async ()=>{
    try{
      uiStatus(true,"Connecting to database‚Ä¶");
      const data = await get();
      lastTotal = data.total;
      Object.assign(state, data);
      uiStatus(true,"Connected ‚úì");
      render();
    }catch(e){ uiStatus(false, "GET error: "+(e?.message||e)); }
  })();
})();
</script>
</body>
</html>
